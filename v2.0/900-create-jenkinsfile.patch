From 520201ed2bbb6d90e319fb98a3413771ce8ab920 Mon Sep 17 00:00:00 2001
From: Nils Andreas Svee <me@lochnair.net>
Date: Sun, 16 Dec 2018 14:49:01 +0200
Subject: [PATCH 1/3] Add Jenkinsfile

---
 Jenkinsfile | 60 +++++++++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 60 insertions(+)
 create mode 100644 Jenkinsfile

diff --git a/Jenkinsfile b/Jenkinsfile
new file mode 100644
index 000000000..d7c666e27
--- /dev/null
+++ b/Jenkinsfile
@@ -0,0 +1,60 @@
+pipeline {
+    agent {
+        docker { image 'lochnair/debian-crossenv:mipsel' }
+    }
+
+    stages {
+        stage('Clean') {
+            steps {
+               sh 'git reset --hard'
+               sh 'git clean -fX'
+            }
+        }
+
+        stage('Install dependencies') {
+            steps {
+                sh 'su-exec root apt-get update'
+                sh 'su-exec root apt-get -y install bc bison flex'
+            }
+        }
+        
+        stage('Prepare for out-of-tree builds') {
+            steps {
+                sh 'make ARCH=mips ubnt_er_e50_defconfig'
+                sh 'make -j5 ARCH=mips CROSS_COMPILE=mipsel-linux-gnu- prepare modules_prepare'
+                sh 'rm -rf tmp && mkdir tmp'
+                sh 'tar --exclude-vcs --exclude=tmp -cf tmp/e50-ksrc.tar .'
+                sh 'mv tmp/e50-ksrc.tar e50-ksrc.tar'
+            }
+        }
+
+        stage('Build') {
+            steps {
+                sh 'make -j5 ARCH=mips CROSS_COMPILE=mipsel-linux-gnu- vmlinux modules'
+                sh './build_image.sh'
+            }
+        }
+        
+        stage('Archive kernel image') {
+            steps {
+                archiveArtifacts artifacts: 'uImage', fingerprint: true, onlyIfSuccessful: true
+            }
+        }
+        
+        stage('Archive kernel modules') {
+            steps {
+                sh 'make ARCH=mips CROSS_COMPILE=mipsel-linux-gnu- INSTALL_MOD_PATH=destdir modules_install'
+                sh 'tar cvjf e50-modules.tar.bz2 -C destdir .'
+                archiveArtifacts artifacts: 'e50-modules.tar.bz2', fingerprint: true, onlyIfSuccessful: true
+            }
+        }
+
+        stage('Archive build tree') {
+            steps {
+                sh 'tar -uvf e50-ksrc.tar Module.symvers'
+                sh 'bzip2 e50-ksrc.tar'
+                archiveArtifacts artifacts: 'e50-ksrc.tar.bz2', fingerprint: true, onlyIfSuccessful: true
+            }
+        }
+    }
+}
-- 
2.23.0

